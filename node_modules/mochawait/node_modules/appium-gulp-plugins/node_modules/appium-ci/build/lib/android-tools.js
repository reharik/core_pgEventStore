'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$defineProperty = require('babel-runtime/core-js/object/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

_Object$defineProperty(exports, '__esModule', {
  value: true
});

var _this = this;

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _stream = require('stream');

var _stream2 = _interopRequireDefault(_stream);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _split = require('split');

var _split2 = _interopRequireDefault(_split);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumLogger = require('appium-logger');

var log = {
  emu: (0, _appiumLogger.getLogger)('android-emu')
};

var DEFAULT_OPTS = {
  initWait: 15000,
  maxWait: 300000,
  pool: 5000
};

var androidTools = {
  killAll: function killAll(processes) {
    var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, p, cmd;

    return _regeneratorRuntime.async(function killAll$(context$1$0) {
      while (1) switch (context$1$0.prev = context$1$0.next) {
        case 0:
          processes = processes || ['emulator'];
          processes = _lodash2['default'].flatten([processes]);
          _iteratorNormalCompletion = true;
          _didIteratorError = false;
          _iteratorError = undefined;
          context$1$0.prev = 5;
          _iterator = _getIterator(processes);

        case 7:
          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
            context$1$0.next = 16;
            break;
          }

          p = _step.value;
          cmd = process.platform.match(/^win/) ? 'powershell -Command "Stop-Process -Name *' + p + '*"' : 'sudo pkill -f ' + p;

          console.log('killing process with command:' + cmd);
          context$1$0.next = 13;
          return _regeneratorRuntime.awrap(_utils2['default'].exec(cmd)['catch'](function () {}));

        case 13:
          _iteratorNormalCompletion = true;
          context$1$0.next = 7;
          break;

        case 16:
          context$1$0.next = 22;
          break;

        case 18:
          context$1$0.prev = 18;
          context$1$0.t0 = context$1$0['catch'](5);
          _didIteratorError = true;
          _iteratorError = context$1$0.t0;

        case 22:
          context$1$0.prev = 22;
          context$1$0.prev = 23;

          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }

        case 25:
          context$1$0.prev = 25;

          if (!_didIteratorError) {
            context$1$0.next = 28;
            break;
          }

          throw _iteratorError;

        case 28:
          return context$1$0.finish(25);

        case 29:
          return context$1$0.finish(22);

        case 30:
        case 'end':
          return context$1$0.stop();
      }
    }, null, _this, [[5, 18, 22, 30], [23,, 25, 29]]);
  }
};

exports.androidTools = androidTools;

var Emulator = (function () {
  function Emulator(avd) {
    var opts = arguments[1] === undefined ? {} : arguments[1];

    _classCallCheck(this, Emulator);

    this.opts = _lodash2['default'].clone(opts);
    _lodash2['default'].defaults(this.opts, DEFAULT_OPTS);
    this.avd = avd;
  }

  _createClass(Emulator, [{
    key: 'start',
    value: function start() {
      var out = new _stream2['default'].PassThrough();
      out.pipe((0, _split2['default'])()).on('data', function (line) {
        log.emu.info(line);
      });
      out.pipe(_fs2['default'].createWriteStream('emulator.log'));
      var emuBin = _os2['default'].platform() === 'linux' ? 'emulator64-x86' : 'emulator';
      var emuArgs = ['-avd', this.avd, '-no-snapshot-load', '-no-snapshot-save', '-no-audio', '-netfast'];
      if (_os2['default'].platform() === 'linux') {
        emuArgs = emuArgs.concat(['-qemu', '-m', '512', '-enable-kvm']);
      }
      log.emu.info('executing', emuBin, emuArgs.join(' '));
      this.child = _utils2['default'].spawn(emuBin, emuArgs);
      this.child.stdout.pipe(out);
      this.child.stderr.pipe(out);
    }
  }, {
    key: 'waitTillReady',
    value: function waitTillReady() {
      var startMs, timeoutPromise, emuStarted, emuErrored, procPromise, _waitForEmu;

      return _regeneratorRuntime.async(function waitTillReady$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startMs = Date.now();
            timeoutPromise = undefined, emuStarted = undefined, emuErrored = undefined;
            procPromise = new _bluebird2['default'].Promise(function (resolve, reject) {
              _this2.child.on('error', function (err) {
                emuErrored = true;
                reject('Emulator didn\'t start properly, error:', err);
              });
              _this2.child.on('close', function () {
                if (!emuStarted) {
                  emuErrored = true;
                  reject('Emulator closed too early, see emu logs for errors.');
                }
              });
            }).cancellable()['catch'](_bluebird2['default'].Promise.CancellationError, function () {});

            _waitForEmu = function _waitForEmu(waitMs) {
              var stdout, _ref, _ref2;

              return _regeneratorRuntime.async(function _waitForEmu$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    waitMs = waitMs || this.opts.pool;

                    if (!(waitMs > 0)) {
                      context$3$0.next = 6;
                      break;
                    }

                    log.emu.info('Waiting ' + waitMs + ' ms for emu...');
                    timeoutPromise = new _bluebird2['default'].Promise(function () {}).timeout(waitMs);context$3$0.next = 6;
                    return _regeneratorRuntime.awrap(timeoutPromise.then(_waitForEmu)['catch'](_bluebird2['default'].Promise.TimeoutError, function () {})['catch'](_bluebird2['default'].Promise.CancellationError, function () {}));

                  case 6:
                    if (!emuErrored) {
                      context$3$0.next = 8;
                      break;
                    }

                    throw new Error('emulator errored');

                  case 8:
                    if (!(Date.now() - startMs > this.opts.maxWait)) {
                      context$3$0.next = 10;
                      break;
                    }

                    throw new Error('Emulator did not show up');

                  case 10:
                    stdout = undefined;
                    context$3$0.prev = 11;
                    context$3$0.next = 14;
                    return _regeneratorRuntime.awrap(_utils2['default'].exec('adb shell getprop sys.boot_completed'));

                  case 14:
                    _ref = context$3$0.sent;
                    _ref2 = _slicedToArray(_ref, 1);
                    stdout = _ref2[0];
                    context$3$0.next = 31;
                    break;

                  case 19:
                    context$3$0.prev = 19;
                    context$3$0.t0 = context$3$0['catch'](11);

                    if (!context$3$0.t0.toString().match(/device not found/)) {
                      context$3$0.next = 26;
                      break;
                    }

                    // there might be something wrong with the adb server
                    log.emu.warn('Device not found, it should be there, killing adb server.');
                    return context$3$0.abrupt('return', _utils2['default'].exec('adb kill-server').then(function () {
                      return _waitForEmu();
                    }));

                  case 26:
                    if (!context$3$0.t0.toString().match(/device offline/)) {
                      context$3$0.next = 30;
                      break;
                    }

                    return context$3$0.abrupt('return', _waitForEmu());

                  case 30:
                    throw context$3$0.t0;

                  case 31:
                    if (!(stdout && stdout.trim() === '1')) {
                      context$3$0.next = 36;
                      break;
                    }

                    log.emu.info('emulator started');
                    emuStarted = true;
                    context$3$0.next = 38;
                    break;

                  case 36:
                    context$3$0.next = 38;
                    return _regeneratorRuntime.awrap(_waitForEmu());

                  case 38:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2, [[11, 19]]);
            };

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_bluebird2['default'].race([_waitForEmu(this.opts.initWait), procPromise])['finally'](function () {
              // cancel outstanding promises so that they do not hang the node process
              timeoutPromise.cancel();
              procPromise.cancel();
            }));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      if (this.child) {
        this.child.kill();
      }
    }
  }]);

  return Emulator;
})();

exports.Emulator = Emulator;

// one cancellable promise monitor the proc events for abnormal termination
// wait
// cancellable

// recursion end conditions

// retrieve emulator status

// that's ok,just wait

// check emulator status

// wait for first promise
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hbmRyb2lkLXRvb2xzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7d0JBQWMsVUFBVTs7OztzQkFDTCxRQUFROzs7O2tCQUNaLElBQUk7Ozs7cUJBQ0QsT0FBTzs7OztrQkFDVixJQUFJOzs7O3FCQUNELFNBQVM7Ozs7c0JBQ2IsUUFBUTs7Ozs0QkFDSSxlQUFlOztBQUV6QyxJQUFJLEdBQUcsR0FBRztBQUNSLEtBQUcsRUFBRSxrQkFIRSxTQUFTLEVBR0QsYUFBYSxDQUFDO0NBQzlCLENBQUM7O0FBRUYsSUFBTSxZQUFZLEdBQUc7QUFDbkIsVUFBUSxFQUFFLEtBQUs7QUFDZixTQUFPLEVBQUUsTUFBTTtBQUNmLE1BQUksRUFBRSxJQUFJO0NBQ1gsQ0FBQzs7QUFFRixJQUFLLFlBQVksR0FBRztBQUNsQixTQUFPLEVBQUUsaUJBQU8sU0FBUzt3RkFHZixDQUFDLEVBQ0gsR0FBRzs7Ozs7QUFIVCxtQkFBUyxHQUFHLFNBQVMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3RDLG1CQUFTLEdBQUcsb0JBQUUsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQzs7Ozs7bUNBQ3RCLFNBQVM7Ozs7Ozs7O0FBQWQsV0FBQztBQUNILGFBQUcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRywyQ0FBMkMsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUMvRixnQkFBZ0IsR0FBRyxDQUFDOztBQUN0QixpQkFBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsR0FBRyxHQUFHLENBQUMsQ0FBQzs7MkNBQzdDLG1CQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBTSxDQUFDLFlBQU0sRUFBRSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBRXhDO0NBQ0YsQ0FBQzs7UUFFTyxZQUFZLEdBQVosWUFBWTs7SUFFUixRQUFRO0FBQ1Is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Q2pDLHVCQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ2pDLDhCQUFVLEdBQUcsSUFBSSxDQUFDOzs7Ozs7cURBRVosV0FBVyxFQUFFOzs7Ozs7O2FBRXZCOzs7NkNBR0ssc0JBQUUsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUMsV0FDbEQsQ0FBQyxZQUFNOztBQUViLDRCQUFjLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDeEIseUJBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUN4QixDQUFDOzs7Ozs7O0tBRUg7OztXQUVHLGdCQUFHO0FBQ0wsVUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO0FBQ2QsWUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztPQUNuQjtLQUNGOzs7U0E5R1UsUUFBUTs7O1FBQVIsUUFBUSxHQUFSLFFBQVEiLCJmaWxlIjoibGliL2FuZHJvaWQtdG9vbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgc3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHNwbGl0IGZyb20gJ3NwbGl0JztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgdXRpbHMgZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZ2V0TG9nZ2VyIH0gZnJvbSAnYXBwaXVtLWxvZ2dlcic7XG5cbmxldCBsb2cgPSB7XG4gIGVtdTogZ2V0TG9nZ2VyKCdhbmRyb2lkLWVtdScpXG59O1xuXG5jb25zdCBERUZBVUxUX09QVFMgPSB7XG4gIGluaXRXYWl0OiAxNTAwMCxcbiAgbWF4V2FpdDogMzAwMDAwLFxuICBwb29sOiA1MDAwLFxufTtcblxubGV0ICBhbmRyb2lkVG9vbHMgPSB7XG4gIGtpbGxBbGw6IGFzeW5jIChwcm9jZXNzZXMpID0+IHtcbiAgICBwcm9jZXNzZXMgPSBwcm9jZXNzZXMgfHwgWydlbXVsYXRvciddO1xuICAgIHByb2Nlc3NlcyA9IF8uZmxhdHRlbihbcHJvY2Vzc2VzXSk7XG4gICAgZm9yKGxldCBwIG9mIHByb2Nlc3Nlcykge1xuICAgICAgbGV0IGNtZCA9IHByb2Nlc3MucGxhdGZvcm0ubWF0Y2goL153aW4vKSA/ICdwb3dlcnNoZWxsIC1Db21tYW5kIFwiU3RvcC1Qcm9jZXNzIC1OYW1lIConICsgcCArICcqXCInIDpcbiAgICAgICAgJ3N1ZG8gcGtpbGwgLWYgJyArIHA7XG4gICAgICBjb25zb2xlLmxvZygna2lsbGluZyBwcm9jZXNzIHdpdGggY29tbWFuZDonICsgY21kKTtcbiAgICAgIGF3YWl0IHV0aWxzLmV4ZWMoY21kKS5jYXRjaCgoKSA9PiB7fSk7XG4gICAgfVxuICB9XG59O1xuXG5leHBvcnQgeyBhbmRyb2lkVG9vbHMgfTtcblxuZXhwb3J0IGNsYXNzIEVtdWxhdG9yIHtcbiAgY29uc3RydWN0b3IoYXZkLCBvcHRzPXt9KSB7XG4gICAgdGhpcy5vcHRzID0gXy5jbG9uZShvcHRzKTtcbiAgICBfLmRlZmF1bHRzKHRoaXMub3B0cywgREVGQVVMVF9PUFRTKTtcbiAgICB0aGlzLmF2ZCA9IGF2ZDtcbiAgfVxuXG4gIHN0YXJ0ICgpIHtcbiAgICBsZXQgb3V0ID0gbmV3IHN0cmVhbS5QYXNzVGhyb3VnaCgpO1xuICAgIG91dC5waXBlKHNwbGl0KCkpXG4gICAgICAub24oJ2RhdGEnLCAobGluZSkgPT4ge1xuICAgICAgICBsb2cuZW11LmluZm8obGluZSk7XG4gICAgICB9KTtcbiAgICBvdXQucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbSgnZW11bGF0b3IubG9nJykpO1xuICAgIGxldCBlbXVCaW4gPSBvcy5wbGF0Zm9ybSgpID09PSAnbGludXgnID8gJ2VtdWxhdG9yNjQteDg2JyA6ICdlbXVsYXRvcic7XG4gICAgbGV0IGVtdUFyZ3MgPSBbXG4gICAgICAnLWF2ZCcsIHRoaXMuYXZkLFxuICAgICAgJy1uby1zbmFwc2hvdC1sb2FkJywgJy1uby1zbmFwc2hvdC1zYXZlJyxcbiAgICAgICctbm8tYXVkaW8nLCAnLW5ldGZhc3QnXG4gICAgXTtcbiAgICBpZiAob3MucGxhdGZvcm0oKSA9PT0gJ2xpbnV4Jykge1xuICAgICAgZW11QXJncyA9IGVtdUFyZ3MuY29uY2F0KFtcbiAgICAgICAgJy1xZW11JywgJy1tJywgJzUxMicsICctZW5hYmxlLWt2bSdcbiAgICAgIF0pO1xuICAgIH1cbiAgICBsb2cuZW11LmluZm8oJ2V4ZWN1dGluZycsIGVtdUJpbiwgZW11QXJncy5qb2luKCcgJykpO1xuICAgIHRoaXMuY2hpbGQgPSB1dGlscy5zcGF3bihlbXVCaW4sIGVtdUFyZ3MpO1xuICAgIHRoaXMuY2hpbGQuc3Rkb3V0LnBpcGUob3V0KTtcbiAgICB0aGlzLmNoaWxkLnN0ZGVyci5waXBlKG91dCk7XG4gIH1cblxuICBhc3luYyB3YWl0VGlsbFJlYWR5KCkge1xuICAgIGxldCBzdGFydE1zID0gRGF0ZS5ub3coKTtcbiAgICBsZXQgdGltZW91dFByb21pc2UsIGVtdVN0YXJ0ZWQsIGVtdUVycm9yZWQ7XG5cbiAgICAvLyBvbmUgY2FuY2VsbGFibGUgcHJvbWlzZSBtb25pdG9yIHRoZSBwcm9jIGV2ZW50cyBmb3IgYWJub3JtYWwgdGVybWluYXRpb25cbiAgICBsZXQgcHJvY1Byb21pc2UgPSBuZXcgQi5Qcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuY2hpbGQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICBlbXVFcnJvcmVkID0gdHJ1ZTtcbiAgICAgICAgcmVqZWN0KCdFbXVsYXRvciBkaWRuXFwndCBzdGFydCBwcm9wZXJseSwgZXJyb3I6JywgZXJyKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5jaGlsZC5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgIGlmICghZW11U3RhcnRlZCkge1xuICAgICAgICAgICAgZW11RXJyb3JlZCA9IHRydWU7XG4gICAgICAgICAgICByZWplY3QoJ0VtdWxhdG9yIGNsb3NlZCB0b28gZWFybHksIHNlZSBlbXUgbG9ncyBmb3IgZXJyb3JzLicpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KS5jYW5jZWxsYWJsZSgpLmNhdGNoKEIuUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvciwgKCkgPT4ge30pO1xuXG4gICAgbGV0IF93YWl0Rm9yRW11ID0gYXN5bmMgKHdhaXRNcykgPT4ge1xuICAgICAgd2FpdE1zID0gd2FpdE1zIHx8IHRoaXMub3B0cy5wb29sO1xuXG4gICAgICAvLyB3YWl0XG4gICAgICBpZiAod2FpdE1zID4gMCkge1xuICAgICAgICBsb2cuZW11LmluZm8oJ1dhaXRpbmcgJyArIHdhaXRNcyArICAnIG1zIGZvciBlbXUuLi4nKTtcbiAgICAgICAgdGltZW91dFByb21pc2UgPSBuZXcgQi5Qcm9taXNlKCgpID0+IHt9KS50aW1lb3V0KHdhaXRNcyk7IC8vIGNhbmNlbGxhYmxlXG4gICAgICAgIGF3YWl0IHRpbWVvdXRQcm9taXNlLnRoZW4oX3dhaXRGb3JFbXUpXG4gICAgICAgICAgICAuY2F0Y2goQi5Qcm9taXNlLlRpbWVvdXRFcnJvciwgKCkgPT4ge30pXG4gICAgICAgICAgICAuY2F0Y2goQi5Qcm9taXNlLkNhbmNlbGxhdGlvbkVycm9yLCAoKSA9PiB7fSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHJlY3Vyc2lvbiBlbmQgY29uZGl0aW9uc1xuICAgICAgaWYgKGVtdUVycm9yZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdlbXVsYXRvciBlcnJvcmVkJyk7XG4gICAgICB9XG4gICAgICBpZiAoRGF0ZS5ub3coKSAtIHN0YXJ0TXMgPiB0aGlzLm9wdHMubWF4V2FpdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VtdWxhdG9yIGRpZCBub3Qgc2hvdyB1cCcpO1xuICAgICAgfVxuXG4gICAgICAvLyByZXRyaWV2ZSBlbXVsYXRvciBzdGF0dXNcbiAgICAgIGxldCBzdGRvdXQ7XG4gICAgICB0cnkge1xuICAgICAgICBbc3Rkb3V0XSA9IGF3YWl0IHV0aWxzLmV4ZWMoJ2FkYiBzaGVsbCBnZXRwcm9wIHN5cy5ib290X2NvbXBsZXRlZCcpO1xuICAgICAgIH0gY2F0Y2goZXJyKSB7XG4gICAgICAgICAgaWYgKGVyci50b1N0cmluZygpLm1hdGNoKC9kZXZpY2Ugbm90IGZvdW5kLykpIHtcbiAgICAgICAgICAgIC8vIHRoZXJlIG1pZ2h0IGJlIHNvbWV0aGluZyB3cm9uZyB3aXRoIHRoZSBhZGIgc2VydmVyXG4gICAgICAgICAgICBsb2cuZW11Lndhcm4oJ0RldmljZSBub3QgZm91bmQsIGl0IHNob3VsZCBiZSB0aGVyZSwga2lsbGluZyBhZGIgc2VydmVyLicpO1xuICAgICAgICAgICAgcmV0dXJuIHV0aWxzLmV4ZWMoJ2FkYiBraWxsLXNlcnZlcicpXG4gICAgICAgICAgICAgIC50aGVuKCgpID0+IHsgcmV0dXJuIF93YWl0Rm9yRW11KCk7IH0pO1xuICAgICAgICAgIH1lbHNlIGlmIChlcnIudG9TdHJpbmcoKS5tYXRjaCgvZGV2aWNlIG9mZmxpbmUvKSkge1xuICAgICAgICAgICAgLy8gdGhhdCdzIG9rLGp1c3Qgd2FpdFxuICAgICAgICAgICAgcmV0dXJuIF93YWl0Rm9yRW11KCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93KGVycik7XG4gICAgICAgICAgfVxuICAgICAgIH1cblxuICAgICAgIC8vIGNoZWNrIGVtdWxhdG9yIHN0YXR1c1xuICAgICAgIGlmIChzdGRvdXQgJiYgc3Rkb3V0LnRyaW0oKSA9PT0gJzEnKSB7XG4gICAgICAgICBsb2cuZW11LmluZm8oJ2VtdWxhdG9yIHN0YXJ0ZWQnKTtcbiAgICAgICAgIGVtdVN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgIH0gZWxzZSB7XG4gICAgICAgICBhd2FpdCBfd2FpdEZvckVtdSgpO1xuICAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gd2FpdCBmb3IgZmlyc3QgcHJvbWlzZVxuICAgIGF3YWl0IEIucmFjZShbX3dhaXRGb3JFbXUodGhpcy5vcHRzLmluaXRXYWl0KSwgcHJvY1Byb21pc2VdKVxuICAgICAgLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICAvLyBjYW5jZWwgb3V0c3RhbmRpbmcgcHJvbWlzZXMgc28gdGhhdCB0aGV5IGRvIG5vdCBoYW5nIHRoZSBub2RlIHByb2Nlc3NcbiAgICAgICAgdGltZW91dFByb21pc2UuY2FuY2VsKCk7XG4gICAgICAgIHByb2NQcm9taXNlLmNhbmNlbCgpO1xuICAgIH0pO1xuXG4gIH1cblxuICBzdG9wKCkge1xuICAgIGlmICh0aGlzLmNoaWxkKSB7XG4gICAgICB0aGlzLmNoaWxkLmtpbGwoKTtcbiAgICB9XG4gIH1cbn1cblxuIl19